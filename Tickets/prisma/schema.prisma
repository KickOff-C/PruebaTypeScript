// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./prisma/dev.db"
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  managerId Int?
  manager   User?    @relation("ManagerEmployees", fields: [managerId], references: [id])
  employees User[]   @relation("ManagerEmployees")
  tickets   Ticket[] @relation("UserTickets")

  // ðŸ‘‡ RelaciÃ³n inversa de transferencias
  receivedTransfers Ticket[] @relation("TicketTransferTo")

  // ðŸ‘‡ Relaciones inversas del historial
  sentHistory     TicketHistory[] @relation("FromUser")
  receivedHistory TicketHistory[] @relation("ToUser")
  comments        TicketComment[]
}

model Ticket {
  id           Int      @id @default(autoincrement())
  title        String
  description  String
  status       Status   @default(OPEN)
  createdAt    DateTime @default(now())
  assignedToId Int?
  assignedTo   User?    @relation("UserTickets", fields: [assignedToId], references: [id])

  // ðŸ‘‡ Nueva relaciÃ³n para transferencia
  transferToId   Int?
  transferTo     User?           @relation("TicketTransferTo", fields: [transferToId], references: [id])
  transferStatus TransferStatus  @default(NONE)
  history        TicketHistory[]
  comments       TicketComment[]
  lastActivityAt DateTime @default(now())
}

model TicketComment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  ticketId  Int
  userId    Int
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model TicketHistory {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  fromId    Int?
  toId      Int?
  fromUser  User?    @relation("FromUser", fields: [fromId], references: [id])
  toUser    User?    @relation("ToUser", fields: [toId], references: [id])
  action    String
  createdAt DateTime @default(now())
}

enum TransferStatus {
  NONE
  PENDING
  APPROVED
  REJECTED
}

enum Status {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum Role {
  USER
  MANAGER
  ADMIN
}
